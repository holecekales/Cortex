var express = require('express');
var iotHubClient = require('./IoTHub/iot-hub');
const moment = require('moment');

let router = express.Router();


var sampleData = [];
/*
[
  {"l":0,"s":0,"t":1505708875702},
  {"l":0.75,"s":1,"t":1505708890702},
  {"l":1.5,"s":1,"t":1505708905702},
  {"l":2.25,"s":1,"t":1505708920702},
  {"l":3,"s":1,"t":1505708935702},
  {"l":3.75,"s":1,"t":1505708950702},
  {"l":4.5,"s":1,"t":1505708965702},
  {"l":5.25,"s":1,"t":1505708980702},
  {"l":6,"s":1,"t":1505708995702},
  {"l":6.75,"s":1,"t":1505709010702},
  {"l":7.5,"s":1,"t":1505709025702},
  {"l":8.25,"s":1,"t":1505709040702},
  {"l":9,"s":1,"t":1505709055702},
  {"l":9.75,"s":1,"t":1505709070702},
  {"l":10.5,"s":1,"t":1505709085702},
  {"l":11.25,"s":1,"t":1505709100702},
  {"l":12,"s":1,"t":1505709115702},
  {"l":12.75,"s":1,"t":1505709130702},
  {"l":13.5,"s":1,"t":1505709145702},
  {"l":14.25,"s":1,"t":1505709160702},
  {"l":15,"s":1,"t":1505709175702},
  {"l":15.75,"s":1,"t":1505709190702},
  {"l":16.5,"s":1,"t":1505709205702},
  {"l":17.25,"s":1,"t":1505709220702},
  {"l":18,"s":1,"t":1505709235702},
  {"l":18.75,"s":1,"t":1505709250702},
  {"l":19.5,"s":1,"t":1505709265702},
  {"l":20.25,"s":1,"t":1505709280702},
  {"l":21,"s":1,"t":1505709295702},
  {"l":21.75,"s":1,"t":1505709310702},
  {"l":22.5,"s":1,"t":1505709325702},
  {"l":23.25,"s":1,"t":1505709340702},
  {"l":24,"s":1,"t":1505709355702},
  {"l":24.75,"s":1,"t":1505709370702},
  {"l":25.5,"s":1,"t":1505709385702},
  {"l":26.25,"s":1,"t":1505709400702},
  {"l":27,"s":1,"t":1505709415702},
  {"l":27.75,"s":1,"t":1505709430702},
  {"l":28.5,"s":1,"t":1505709445702},
  {"l":29.25,"s":1,"t":1505709460702},
  {"l":0,"s":1,"t":1505709475702},
  {"l":0.75,"s":0,"t":1505709490702},
  {"l":1.5,"s":0,"t":1505709505702},
  {"l":2.25,"s":0,"t":1505709520702},
  {"l":3,"s":0,"t":1505709535702},
  {"l":3.75,"s":0,"t":1505709550702},
  {"l":4.5,"s":0,"t":1505709565702},
  {"l":5.25,"s":0,"t":1505709580702},
  {"l":6,"s":0,"t":1505709595702},
  {"l":6.75,"s":0,"t":1505709610702},
  {"l":7.5,"s":0,"t":1505709625702},
  {"l":8.25,"s":0,"t":1505709640702},
  {"l":9,"s":0,"t":1505709655702},
  {"l":9.75,"s":0,"t":1505709670702},
  {"l":10.5,"s":0,"t":1505709685702},
  {"l":11.25,"s":0,"t":1505709700702},
  {"l":12,"s":0,"t":1505709715702},
  {"l":12.75,"s":0,"t":1505709730702},
  {"l":13.5,"s":0,"t":1505709745702},
  {"l":14.25,"s":0,"t":1505709760702},
  {"l":15,"s":0,"t":1505709775702},
  {"l":15.75,"s":0,"t":1505709790702},
  {"l":16.5,"s":0,"t":1505709805702},
  {"l":17.25,"s":0,"t":1505709820702},
  {"l":18,"s":0,"t":1505709835702},
  {"l":18.75,"s":0,"t":1505709850702},
  {"l":19.5,"s":0,"t":1505709865702},
  {"l":20.25,"s":0,"t":1505709880702},
  {"l":21,"s":0,"t":1505709895702},
  {"l":21.75,"s":0,"t":1505709910702},
  {"l":22.5,"s":0,"t":1505709925702},
  {"l":23.25,"s":0,"t":1505709940702},
  {"l":24,"s":0,"t":1505709955702},
  {"l":24.75,"s":0,"t":1505709970702},
  {"l":25.5,"s":0,"t":1505709985702},
  {"l":26.25,"s":0,"t":1505710000702},
  {"l":27,"s":0,"t":1505710015702},
  {"l":27.75,"s":0,"t":1505710030702},
  {"l":28.5,"s":0,"t":1505710045702},
  {"l":29.25,"s":0,"t":1505710060702},
  {"l":0,"s":0,"t":1505710075702},
  {"l":0.75,"s":1,"t":1505710090702},
  {"l":1.5,"s":1,"t":1505710105702},
  {"l":2.25,"s":1,"t":1505710120702},
  {"l":3,"s":1,"t":1505710135702},
  {"l":3.75,"s":1,"t":1505710150702},
  {"l":4.5,"s":1,"t":1505710165702},
  {"l":5.25,"s":1,"t":1505710180702},
  {"l":6,"s":1,"t":1505710195702},
  {"l":6.75,"s":1,"t":1505710210702},
  {"l":7.5,"s":1,"t":1505710225702},
  {"l":8.25,"s":1,"t":1505710240702},
  {"l":9,"s":1,"t":1505710255702},
  {"l":9.75,"s":1,"t":1505710270702},
  {"l":10.5,"s":1,"t":1505710285702},
  {"l":11.25,"s":1,"t":1505710300702},
  {"l":12,"s":1,"t":1505710315702},
  {"l":12.75,"s":1,"t":1505710330702},
  {"l":13.5,"s":1,"t":1505710345702},
  {"l":14.25,"s":1,"t":1505710360702},
  {"l":15,"s":1,"t":1505710375702},
  {"l":15.75,"s":1,"t":1505710390702},
  {"l":16.5,"s":1,"t":1505710405702},
  {"l":17.25,"s":1,"t":1505710420702},
  {"l":18,"s":1,"t":1505710435702},
  {"l":18.75,"s":1,"t":1505710450702},
  {"l":19.5,"s":1,"t":1505710465702},
  {"l":20.25,"s":1,"t":1505710480702},
  {"l":21,"s":1,"t":1505710495702},
  {"l":21.75,"s":1,"t":1505710510702},
  {"l":22.5,"s":1,"t":1505710525702},
  {"l":23.25,"s":1,"t":1505710540702},
  {"l":24,"s":1,"t":1505710555702},
  {"l":24.75,"s":1,"t":1505710570702},
  {"l":25.5,"s":1,"t":1505710585702},
  {"l":26.25,"s":1,"t":1505710600702},
  {"l":27,"s":1,"t":1505710615702},
  {"l":27.75,"s":1,"t":1505710630702},
  {"l":28.5,"s":1,"t":1505710645702},
  {"l":29.25,"s":1,"t":1505710660702},
  {"l":0,"s":1,"t":1505710675702},
  {"l":0.75,"s":0,"t":1505710690702},
  {"l":1.5,"s":0,"t":1505710705702},
  {"l":2.25,"s":0,"t":1505710720702},
  {"l":3,"s":0,"t":1505710735702},
  {"l":3.75,"s":0,"t":1505710750702},
  {"l":4.5,"s":0,"t":1505710765702},
  {"l":5.25,"s":0,"t":1505710780702},
  {"l":6,"s":0,"t":1505710795702},
  {"l":6.75,"s":0,"t":1505710810702},
  {"l":7.5,"s":0,"t":1505710825702},
  {"l":8.25,"s":0,"t":1505710840702},
  {"l":9,"s":0,"t":1505710855702},
  {"l":9.75,"s":0,"t":1505710870702},
  {"l":10.5,"s":0,"t":1505710885702},
  {"l":11.25,"s":0,"t":1505710900702},
  {"l":12,"s":0,"t":1505710915702},
  {"l":12.75,"s":0,"t":1505710930702},
  {"l":13.5,"s":0,"t":1505710945702},
  {"l":14.25,"s":0,"t":1505710960702},
  {"l":15,"s":0,"t":1505710975702},
  {"l":15.75,"s":0,"t":1505710990702},
  {"l":16.5,"s":0,"t":1505711005702},
  {"l":17.25,"s":0,"t":1505711020702},
  {"l":18,"s":0,"t":1505711035702},
  {"l":18.75,"s":0,"t":1505711050702},
  {"l":19.5,"s":0,"t":1505711065702},
  {"l":20.25,"s":0,"t":1505711080702},
  {"l":21,"s":0,"t":1505711095702},
  {"l":21.75,"s":0,"t":1505711110702},
  {"l":22.5,"s":0,"t":1505711125702},
  {"l":23.25,"s":0,"t":1505711140702},
  {"l":24,"s":0,"t":1505711155702},
  {"l":24.75,"s":0,"t":1505711170702},
  {"l":25.5,"s":0,"t":1505711185702},
  {"l":26.25,"s":0,"t":1505711200702},
  {"l":27,"s":0,"t":1505711215702},
  {"l":27.75,"s":0,"t":1505711230702},
  {"l":28.5,"s":0,"t":1505711245702},
  {"l":29.25,"s":0,"t":1505711260702},
  {"l":0,"s":0,"t":1505711275702},
  {"l":0.75,"s":1,"t":1505711290702},
  {"l":1.5,"s":1,"t":1505711305702},
  {"l":2.25,"s":1,"t":1505711320702},
  {"l":3,"s":1,"t":1505711335702},
  {"l":3.75,"s":1,"t":1505711350702},
  {"l":4.5,"s":1,"t":1505711365702},
  {"l":5.25,"s":1,"t":1505711380702},
  {"l":6,"s":1,"t":1505711395702},
  {"l":6.75,"s":1,"t":1505711410702},
  {"l":7.5,"s":1,"t":1505711425702},
  {"l":8.25,"s":1,"t":1505711440702},
  {"l":9,"s":1,"t":1505711455702},
  {"l":9.75,"s":1,"t":1505711470702},
  {"l":10.5,"s":1,"t":1505711485702},
  {"l":11.25,"s":1,"t":1505711500702},
  {"l":12,"s":1,"t":1505711515702},
  {"l":12.75,"s":1,"t":1505711530702},
  {"l":13.5,"s":1,"t":1505711545702},
  {"l":14.25,"s":1,"t":1505711560702},
  {"l":15,"s":1,"t":1505711575702},
  {"l":15.75,"s":1,"t":1505711590702},
  {"l":16.5,"s":1,"t":1505711605702},
  {"l":17.25,"s":1,"t":1505711620702},
  {"l":18,"s":1,"t":1505711635702},
  {"l":18.75,"s":1,"t":1505711650702},
  {"l":19.5,"s":1,"t":1505711665702},
  {"l":20.25,"s":1,"t":1505711680702},
  {"l":21,"s":1,"t":1505711695702},
  {"l":21.75,"s":1,"t":1505711710702},
  {"l":22.5,"s":1,"t":1505711725702},
  {"l":23.25,"s":1,"t":1505711740702},
  {"l":24,"s":1,"t":1505711755702},
  {"l":24.75,"s":1,"t":1505711770702},
  {"l":25.5,"s":1,"t":1505711785702},
  {"l":26.25,"s":1,"t":1505711800702},
  {"l":27,"s":1,"t":1505711815702},
  {"l":27.75,"s":1,"t":1505711830702},
  {"l":28.5,"s":1,"t":1505711845702},
  {"l":29.25,"s":1,"t":1505711860702}
];
*/

// routes
router.use('/', function (req, res, next) {
  res.status(200).json(sampleData);
});


// ------------------------------------------------------------------------------------
// Pump
// ------------------------------------------------------------------------------------
class Pump {

  private socket = null;
  private iotHubReader = null;

  // open the Event Hub
  readonly connectionString: string = 'HostName=IoTpump.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=NgVcqeqxlrecmyehSEDp0ghE6tPhQzjjzx7qpfDdsq0=';
  readonly consumerGroup: string = 'eventdatagroup';


  // ------------------------------------------------------------------------------------
  // constructor
  // ------------------------------------------------------------------------------------
  constructor() {
    this.iotHubReader = new iotHubClient(this.connectionString, this.consumerGroup);
    this.iotHubReader.startReadMessage((obj, date) => {
      try {
        if (obj.time == undefined) {
          obj["time"] = Date.now();
        }

        sampleData.push(obj);

        let msg = JSON.stringify(obj);
        console.log('socket msg: ' + msg);

        if (this.socket) {
          this.socket.broadcast(msg);
        }
      }
      catch (err) {
        console.log('Error pushing message out');
        console.log(obj);
        console.error(err);
      }
    });
  }

  // set socket
  setSocket(s) { this.socket = s; }

  // recieve data from socket
  rcvData(data: string) {
    try {
      let obj = JSON.parse(data);

      if (obj.m == "d") {
        delete obj.m;
        sampleData.push(obj);
        this.socket.broadcast(JSON.stringify(obj));
      }
    }
    catch (err) {
      console.log('Error pushing message out');
      console.log(data);
      console.error(err);
    }
  }
}

module.exports = { "router": router, "pump": new Pump() };


